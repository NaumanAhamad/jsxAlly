var isExtension;try{isExtension=null!=chrome.extension}catch(e){isExtension=!1}isExtension?chrome.extension.connect({name:"A11Y Communication"}).onMessage.addListener(function(e){initPanel(e)}):$("#inspectNode").parent("span").addClass("hide"),$(window).on("message",function(e){initPanel(e.originalEvent.data)});var appURL,errorObject="",filteredList="",categoryIssueList="",baseErrorObjestDefined=!1,bodyHeight=$("body").height(),analyzeHeaderHeight=$(".analyze-button-wrapper .header").height();$(window).on("load",function(e){$(window).trigger("resize")}),$(document).on("click",".a11y-level-link",function(e){if(e.preventDefault(),"AAA"===$(this).text().trim())return!1;$(this).nextAll("a").removeClass("selected"),$(this).addClass("selected"),$(this).prevAll("a").addClass("selected"),initPanel({content:levelFilter($(this).text().trim())})});var levelFilter=function(e){var t=["A","AA"];switch(void 0===e&&(e="AA"),e){case"A":t=["A",""];break;case"AA":t=["A","AA",""];break;case"AAA":t=["A","AA","AAA",""];break;default:t=["A","AA",""]}return getlevelList(baseErrorObject,t)},getlevelList=function(e,s){return e.issues.reduce(function(e,t){return-1!==s.indexOf(t.Issue.level.trim())&&e.push(t),e},[])},getTotals=function(e,s){return e.reduce(function(e,t){return t.Issue[s]in e?e[t.Issue[s]]++:e[t.Issue[s]]=1,e},{})},generateIssueObject=function(e){var t=getTotals(e,"violation");return{totalIssueCount:e.length,totalErrorCount:t.true,totalWarningCount:t.false,category:(categoryList=getTotals(e,"category"),Object.keys(categoryList).sort().reduce(function(e,t){return e[t]=categoryList[t],e},{})),issues:e}},initPanel=function(e){if(""==e.content)return $(".success-container").removeClass("hide"),$(".utility-toggler").css("visibility","hidden"),$(".loading-container, .a11y-level-wrapper").addClass("hide"),void $(window).trigger("resize");if("refresh"==e.content)return $(".results-wrapper, .results-wrapper .a11y-content-wrapper, .success-container").addClass("hide"),$(".analyze-button-wrapper").removeClass("hide"),!1;baseErrorObjestDefined||(baseErrorObject=JSON.parse(JSON.stringify(generateIssueObject(e.content))),baseErrorObjestDefined=!0),$(".analyze-button-wrapper, .success-container").addClass("hide"),$(".results-wrapper").removeClass("hide"),errorObject=generateIssueObject(levelFilter($(".a11y-level-link.selected:last").text().trim()));var s="",r="";$(".total-issues-count").text(errorObject.totalIssueCount),$(".total-errors-count").text(errorObject.totalErrorCount),$(".total-warnings-count").text(errorObject.totalWarningCount),void 0===errorObject.totalWarningCount&&$(".total-warnings-count").text("0"),$.each(errorObject.category,function(e,t){switch(e){case"Color":r="fa fa-paint-brush";break;case"Content":r="fa fa-file-text";break;case"CSS":r="glyphicon glyphicon-export";break;case"Keyboard":r="fa fa-keyboard-o";break;case"Markup":r="fa fa-code";break;case"Navigation":r="fa fa-angle-double-right";break;case"Table":r="fa fa-table";break;case"Images":r="fa fa-file-image-o";break;case"Links":r="fa fa-link";break;case"Forms":r="fa fa-files-o";break;case"Multimedia":r="fa fa-file-video-o"}s+='<li><a href="#" class="category_tablinks"><span class="'+r+' icon"></span><span class="category-name">'+e+'</span><span class="badge">'+t+'</span><span class="icon-collapse"></span></a><ul class="nav nav-pills nav-stacked issue-section-wrapper hide"></ul></li>'}),$(".category-list").html("").append(s);var t=$(window).height();$(".category-section").css("height",t-$(".sidenav .header").height()),$(".recomendation-column").css("height",t),$(".category-section").niceScroll({cursorborder:"",cursorcolor:"#A30001",horizrailenabled:!1,railpadding:{top:0,right:-6,left:0,bottom:0}}),$(".issue-section-wrapper, .recomendation-column").niceScroll({cursorborder:"",cursorcolor:"#A30001",horizrailenabled:!1}),$("#highlightElem").on("click",function(e){e.preventDefault();var t=$(this).attr("attr-xpath");isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('highlightElement','"+t+"')"}):sendObjectToIframe("highlightElement",t)}),$("#inspectNode").on("click",function(){if(isExtension){chrome.devtools.inspectedWindow.eval("inspect(document.querySelector('.curr-insp-elem'))")}}),$(".a11y-content-wrapper.hide").removeClass("hide"),$(".loading-container").addClass("hide"),$("#reAnalyzePage").removeClass("disble-events"),appURL=e.url,fetchLocalStorageData(appURL),excelExport(errorObject.issues,appURL),$(".category_tablinks:first").trigger("click")};$(document).on("click",".category_tablinks",function(e){if(e.preventDefault(),$(this).hasClass("active"))$(".category-list .category_tablinks").removeClass("active"),$(".issue-section-wrapper li").removeClass("active"),$(this).find(".expand-icon").html("&#xf067;"),$(this).parents("li").find(".issue-section-wrapper").addClass("hide"),$(".utility-toggler").css("visibility","hidden"),$(".issue-inspect, .issue-highlight").addClass("disabled"),$(".current-issue-text").html("Issue description will come here."),$(".issue-recommendation").html("Issue Recommendation will come here."),$(".issue-criteria").html("Issue Criteria will come here."),$(".issue-guideline").html("Guidelines will come here."),$(".issue-location").text("Location(XPATH) of element will come here."),$(".issue-source").text("Element will come here."),$(window).trigger("resize");else{var t=$(this).find(".category-name").text();$(".category-list .category_tablinks").removeClass("active"),$(this).parents("li").find(".category_tablinks").addClass("active"),$(".category_tablinks .expand-icon").html("&#xf067;"),$(this).find(".expand-icon").html("&#xf068;"),$(".utility-toggler").css("visibility","visible"),$(".issue-inspect, .issue-highlight").removeClass("disabled"),categoryIssueList="",filteredList=getFilteredList(errorObject,t);var s="";$.each(filteredList,function(e,t){s="error",t.Issue.violation||(s="warning"),categoryIssueList+='<li class="'+s+'"><a href="#" attr-index='+e+' title="'+t.Issue.errorText+'"><span class="issue-element">'+t.Element+'</span><span class="issue-separator">|</span><span class="issue-text">'+t.Issue.errorText+'</span><span class="fa fa-chevron-right icon"></span></a></li>'}),$(this).next(".issue-section-wrapper").html("").append(categoryIssueList),$(".issue-section-wrapper").addClass("hide"),$(this).parents("li").find(".issue-section-wrapper").removeClass("hide"),$(".recomendation-column").removeClass("hide"),$(this).parents("li").find(".issue-section-wrapper a:first").trigger("click")}}),$(document).on("click",".issue-section-wrapper a",function(){if(!$(this).parent("li").hasClass("active")){var e=$(this).attr("attr-index"),t=filteredList[e].XPath;isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('addInspectClass','"+t+"')"}):sendObjectToIframe("addInspectClass",t),$(".issue-section-wrapper li").removeClass("active"),$(this).parent("li").addClass("active"),$(".issue-highlight").removeClass("disabled"),$(".issue-highlight").parent().attr("title","Highlight element."),"invisible-icon"==filteredList[e].Visibility&&($(".issue-highlight").addClass("disabled"),$(".issue-highlight").parent().attr("title","Element is offscreen.")),$(".current-issue-text").html(filteredList[e].Issue.errorText),$(".issue-recommendation").html(filteredList[e].Recommendations),$(".issue-criteria").html(filteredList[e].Issue.criteria),$(".issue-guideline").html(filteredList[e].Guideline),null===filteredList[e].XPath?$(".issue-location").text("Element not present."):$(".issue-location").text(filteredList[e].XPath),$(".issue-source").text("<"+filteredList[e].Element+">"),$("#devComments").attr("data-index",e),$("#devComments").val(filteredList[e].DevComments),$(".issue-highlight").attr("attr-xpath",filteredList[e].XPath),$(".recomendation-column").scrollTop(0)}$(window).trigger("resize")}),$(document).on("click","a.disbled",function(e){e.preventDefault()}),$(document).on("click","#analyzePage",function(){$(".analyze-button-wrapper").addClass("hide"),$(".results-wrapper.hide").removeClass("hide"),isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('analyzePage','')"}):sendObjectToIframe("analyzePage","")}),$(document).on("click","#reAnalyzePage",function(e){e.preventDefault(),baseErrorObjestDefined=!1,$(this).addClass("disble-events"),$(".results-wrapper .a11y-content-wrapper, .success-container").addClass("hide"),$(".loading-container.hide").removeClass("hide"),isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('analyzePage','')"}):sendObjectToIframe("analyzePage","")}),$(window).on("resize",function(e){var t=$(window).height();$(document).find(".category-section").css("height",t-$(".results-wrapper .header").outerHeight()),$(document).find(".recomendation-column").css("height",t-$(".results-wrapper .header").outerHeight()),$(document).find(".recomendation-highlights").css("height",t-$(".results-wrapper .header").outerHeight()),$(document).find(".category-section").niceScroll({cursorborder:"",cursorcolor:"#A30001",horizrailenabled:!1,railpadding:{top:0,right:-6,left:0,bottom:0}}),$(document).find(".recomendation-column, .issue-section-wrapper, .analyze-button-wrapper .recomendation-highlights").niceScroll({cursorborder:"",cursorcolor:"#A30001",horizrailenabled:!1})}),$(document).on("change","#a11y-resize-slider, #a11y-resize-slider-home",function(){var e,t,s=$(this).val();switch(isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('textResize','"+s+"')"}):sendObjectToIframe("textResize",s),s){case"-1":e="Very Small",t="56.25%";break;case"-0.5":e="Small",t="75%";break;case"0":e="Medium",t="100%";break;case"0.5":e="Large",t="125%";break;case"1":e="Very Large",t="150%"}$(".current-text-size").text(e),$(".a11y-resize-label").attr("title",t)}),$(document).on("blur","#devComments",function(e){var t=$(this).attr("data-index");filteredList[t].DevComments=$(this).val(),storeInLocalStorage(filteredList[t],appURL),excelExport(errorObject.issues,appURL)}),$(document).on("click","#disableCss",function(){$(this).hasClass("activated")?isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('cssDisable', 'activated')"}):sendObjectToIframe("cssDisable","activated"):isExtension?sendObjectToInspectedPage({action:"code",content:"callInspectedWindowFn('cssDisable', '')"}):sendObjectToIframe("cssDisable",""),$(this).toggleClass("activated")});var getFilteredList=function(e,s){return e.issues.reduce(function(e,t){return t.Issue.category===s&&e.push(t),e},[])},excelExport=function(e,a){$("#exportIssues").DataTable().destroy();var t=JSON.parse(JSON.stringify(e));$("#exportIssues").DataTable({data:t,paging:!1,searching:!1,bInfo:!1,buttons:[{extend:"excelHtml5",messageTop:function(){var e=new Date,t=e.getMonth()+1,s=e.getDate(),r=e.getFullYear()+"/"+(t<10?"0":"")+t+"/"+(s<10?"0":"")+s;return"URL: "+a+"    ||    Date: "+r},sheetName:"Issue Details",text:'<span class="fa fa-download icon"></span>EXPORT',title:"Issue Report",filename:"Ally Issue Report",customize:function(e){var r=e.xl.worksheets["sheet1.xml"];$('row c[r^="A"]',r).attr("s","55"),$('row c[r^="B"]',r).attr("s","55"),$('row c[r^="C"]',r).attr("s","55"),$('row c[r^="D"]',r).attr("s","55"),$('row c[r^="E"]',r).attr("s","55"),$('row c[r^="F"]',r).attr("s","55"),$('row c[r^="G"]',r).attr("s","55"),$('row c[r^="H"]',r).attr("s","55"),$('row c[r^="I"]',r).attr("s","55");var t=$("col",r);$(t[0]).attr("width",50),$(t[1]).attr("width",40),$(t[2]).attr("width",40),$(t[3]).attr("width",20),$(t[4]).attr("width",20),$(t[5]).attr("width",10),$(t[6]).attr("width",40),$(t[7]).attr("width",20),$(t[8]).attr("width",50),$("row",r).filter(function(e,t){var s=$(this).attr("r");$("row",r).length;$.each(["A","B","C","D","E","F","G","H","I"],function(e,t){1==s&&($("c[r="+t+s+"]",r).attr("s","2"),$("c[r="+t+s+"]",r).attr("s","51")),2==s&&$("c[r="+t+s+"]",r).attr("s","51"),3==s&&$("c[r="+t+s+"]",r).attr("s","7")})})}}],dom:"Bfrtip",columns:[{data:null,render:function(e,t,s){return e.Element}},{data:null,render:function(e,t,s){return e.XPath}},{data:null,render:function(e,t,s){return e.Issue.errorText}},{data:null,render:function(e,t,s){return e.Issue.violation?"Error":"Warning"}},{data:null,render:function(e,t,s){return e.Issue.category}},{data:null,render:function(e,t,s){return e.Issue.level+" &#xA;"+e.Issue.criteria}},{data:null,render:function(e,t,s){return e.Recommendations}},{data:null,render:function(e,t,s){return"Open"}},{data:null,render:function(e,t,s){return e.DevComments}}]})};function sendObjectToInspectedPage(e){e.tabId=chrome.devtools.inspectedWindow.tabId,chrome.extension.sendMessage(e)}function sendObjectToIframe(e,t){e='callInspectedWindowFn("'+e+'","'+t+'")';window.parent.postMessage(e,"*")}var storeInLocalStorage=function(e,t){if("undefined"!=typeof Storage){var s=JSON.parse(localStorage.getItem("Ally"+t));s=null==s?[]:s;for(var r,a,i=!1,n=0;n<s.length;n++)if(s[n].XPath==e.XPath&&s[n].Issue==e.Issue.errorText){""!=e.DevComments?(s[n].DevComments=e.DevComments,i=!0):a=n,r=!0;break}if(r&&!i)s.splice(a,1);else if(!r&&""!=e.DevComments){var o={};o.XPath=e.XPath,o.Issue=e.Issue.errorText,o.DevComments=e.DevComments,s.push(o)}localStorage.setItem("Ally"+t,JSON.stringify(s))}},fetchLocalStorageData=function(e){if("undefined"!=typeof Storage){var t=JSON.parse(localStorage.getItem("Ally"+e));if(null!=t)for(var s=0;s<t.length;s++)for(var r=0;r<errorObject.issues.length;r++)if(t[s].XPath==errorObject.issues[r].XPath&&t[s].Issue==errorObject.issues[r].Issue.errorText){errorObject.issues[r].DevComments=t[s].DevComments;break}}};